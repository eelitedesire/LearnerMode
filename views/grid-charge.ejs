<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy System - Grid Charge Settings</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border-radius: 8px;
            border: none;
        }
        .card-header {
            background-color: #f1f8ff;
            border-bottom: 1px solid #e3f2fd;
            border-radius: 8px 8px 0 0 !important;
        }
        .change-item {
            cursor: pointer;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .change-item:hover {
            background-color: #f8f9fa;
        }
        .change-item:last-child {
            border-bottom: none;
        }
        .change-value {
            font-weight: 500;
        }
        .inverter-heading {
            background-color: #e9ecef;
            padding: 10px 15px;
            font-weight: 600;
            margin-top: 15px;
            border-radius: 5px;
        }
        .modal-header {
            background-color: #f1f8ff;
        }
        .timestamp {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .setting-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .edit-icon {
            color: #007bff;
            opacity: 0.7;
        }
        .change-item:hover .edit-icon {
            opacity: 1;
        }
        .nav-link.active {
            font-weight: bold;
            color: #007bff !important;
        }
        .grid-list {
            max-height: 500px;
            overflow-y: auto;
        }
        .grid-charge-table th,
        .grid-charge-table td {
            vertical-align: middle;
        }
        .no-points-message {
            padding: 30px;
            text-align: center;
            color: #6c757d;
        }
        .status-icon {
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-solar-panel me-2"></i>Energy System Monitor</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/grid-charge"><i class="fas fa-plug me-1"></i>Grid Charge</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/energy-pattern"><i class="fas fa-battery-three-quarters me-1"></i>Energy Pattern</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/work-mode"><i class="fas fa-cogs me-1"></i>Work Mode</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/battery-charging"><i class="fas fa-charging-station me-1"></i>Battery Charging</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/voltage-point"><i class="fas fa-bolt me-1"></i>Voltage Points</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/rules"><i class="fas fa-tasks me-1"></i>Rules</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/learner"><i class="fas fa-brain me-1"></i>Learner</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Alerts container -->
        <div id="alerts-container"></div>

        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-plug me-2"></i>Grid Charge Settings</h5>
                        <div>
                            <button class="btn btn-outline-primary me-2" id="view-history-btn">
                                <i class="fas fa-history me-1"></i> View History
                            </button>
                            <button class="btn btn-primary" id="refresh-grid-charge">
                                <i class="fas fa-sync-alt me-1"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Grid charge settings control how your system interacts with the grid. You can enable/disable grid charging, set maximum grid charge current, and configure grid charge points.
                        </div>
                        
                        <ul class="nav nav-tabs mb-3" id="gridChargeTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="main-settings-tab" data-bs-toggle="tab" data-bs-target="#main-settings" type="button" role="tab" aria-controls="main-settings" aria-selected="true">
                                    <i class="fas fa-cog me-1"></i> Main Settings
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="charge-points-tab" data-bs-toggle="tab" data-bs-target="#charge-points" type="button" role="tab" aria-controls="charge-points" aria-selected="false">
                                    <i class="fas fa-list-ol me-1"></i> Charge Points
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="gridChargeTabContent">
                            <!-- Main Settings Tab -->
                            <div class="tab-pane fade show active" id="main-settings" role="tabpanel" aria-labelledby="main-settings-tab">
                                <div class="table-responsive">
                                    <table class="table table-hover grid-charge-table">
                                        <thead>
                                            <tr>
                                                <th>Inverter</th>
                                                <th>Grid Charge Status</th>
                                                <th>Max Current</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="grid-charge-list">
                                            <tr>
                                                <td colspan="4" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status"></div>
                                                    <div class="mt-2">Loading grid charge settings...</div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Charge Points Tab -->
                            <div class="tab-pane fade" id="charge-points" role="tabpanel" aria-labelledby="charge-points-tab">
                                <div class="table-responsive">
                                    <table class="table table-hover grid-charge-table">
                                        <thead>
                                            <tr>
                                                <th>Charge Point & Topic</th>
                                                <th>Value</th>
                                                <th>Last Updated</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="charge-points-list">
                                            <tr>
                                                <td colspan="4" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status"></div>
                                                    <div class="mt-2">Loading grid charge points...</div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Add Button for Adding New Charge Point -->
                                <div class="text-center mt-3">
                                    <button class="btn btn-outline-primary" id="add-charge-point-btn">
                                        <i class="fas fa-plus-circle me-1"></i> Add New Charge Point
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Grid Charge Info</h5>
                    </div>
                    <div class="card-body" id="grid-charge-info">
                        <p>Grid charging allows your system to use power from the grid to charge your batteries. These settings help optimize when and how much grid power is used for charging.</p>
                        
                        <h6 class="mt-4">Grid Charge Summary</h6>
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Inverters with Grid Charge Enabled
                                <span class="badge bg-success rounded-pill" id="enabled-grid-charge">--</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Total Inverters
                                <span class="badge bg-primary rounded-pill" id="inverter-count">--</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Active Grid Charge Points
                                <span class="badge bg-info rounded-pill" id="active-charge-points">--</span>
                            </li>
                        </ul>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Changes to grid charge settings take effect immediately. Use caution when modifying these values.
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Changes</h5>
                    </div>
                    <div class="card-body">
                        <div class="grid-list" id="recent-changes">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <div class="mt-2">Loading recent changes...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Grid Charge Status Modal -->
    <div class="modal fade" id="editGridChargeModal" tabindex="-1" aria-labelledby="editGridChargeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editGridChargeModalLabel">Edit Grid Charge Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editGridChargeForm">
                        <input type="hidden" id="edit-inverter">
                        <input type="hidden" id="edit-setting-type">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold" id="setting-name-display">Setting</label>
                            <p class="text-muted small" id="setting-inverter-display">Inverter</p>
                            <p class="text-muted small" id="setting-topic-display" style="word-break: break-all;">Topic</p>
                        </div>
                        
                        <div class="mb-3" id="toggle-container">
                            <label class="form-label">Grid Charge Status</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="grid-charge-toggle">
                                <label class="form-check-label" for="grid-charge-toggle" id="toggle-label">Enable Grid Charge</label>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="current-container">
                            <label for="edit-current" class="form-label">Max Grid Charge Current (A)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="edit-current" min="0" max="100" step="0.1">
                                <span class="input-group-text">A</span>
                            </div>
                            <div class="form-text">Recommended range: 0A - 100A</div>
                        </div>
                        
                        <div class="mb-3" id="point-container">
                            <label for="edit-point-value" class="form-label">Charge Point Value</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="edit-point-value" min="0" max="100" step="0.1">
                                <span class="input-group-text" id="point-unit">V</span>
                            </div>
                            <div class="form-text" id="point-range-text">Recommended range: 0-100</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Current Value</label>
                            <p class="form-control-plaintext" id="current-value-display">-</p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-setting-btn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Grid Charge History Modal -->
    <div class="modal fade" id="gridChargeHistoryModal" tabindex="-1" aria-labelledby="gridChargeHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="gridChargeHistoryModalLabel">Grid Charge Change History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Setting</th>
                                    <th>Old Value</th>
                                    <th>New Value</th>
                                </tr>
                            </thead>
                            <tbody id="grid-history-list">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <div class="mt-2">Loading history...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Charge Point Modal -->
    <div class="modal fade" id="addChargePointModal" tabindex="-1" aria-labelledby="addChargePointModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addChargePointModalLabel">Add New Charge Point</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addChargePointForm">
                        <div class="mb-3">
                            <label for="new-inverter" class="form-label">Inverter</label>
                            <select class="form-select" id="new-inverter" required>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="new-point-number" class="form-label">Point Number</label>
                            <input type="number" class="form-control" id="new-point-number" min="1" max="10" value="1" required>
                            <div class="form-text">Enter a number from 1-10 for the charge point</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="new-point-value" class="form-label">Point Value</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="new-point-value" step="0.1" required>
                                <span class="input-group-text">V</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-new-point-btn">Add Charge Point</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script>
    // Global variables
let gridChargeSettings = {};
let chargePoints = {};
let mqttTopicPrefix = 'energy'; // Default prefix, can be updated from server

// Initialize the page
$(document).ready(function() {
    // Load grid charge settings
    loadGridChargeSettings();
    
    // Load grid charge points
    loadGridChargePoints();
    
    // Load recent changes
    loadRecentChanges();
    
    // Set up event listeners
    setupEventListeners();
});

// Setup event listeners
function setupEventListeners() {
    // Refresh button
    $('#refresh-grid-charge').click(function() {
        loadGridChargeSettings();
        loadGridChargePoints();
        showAlert('info', 'Grid charge settings refreshed');
    });
    
    // Save setting button
    $('#save-setting-btn').click(function() {
        saveGridChargeSetting();
    });
    
    // View history button
    $('#view-history-btn').click(function() {
        loadGridChargeHistory();
        const historyModal = new bootstrap.Modal(document.getElementById('gridChargeHistoryModal'));
        historyModal.show();
    });
    
    // Add charge point button
    $('#add-charge-point-btn').click(function() {
        openAddChargePointModal();
    });
    
    // Save new charge point button
    $('#save-new-point-btn').click(function() {
        saveNewChargePoint();
    });
}

// Load grid charge settings from the API
function loadGridChargeSettings() {
    $.ajax({
        url: '/api/grid-charge-changes',
        method: 'GET',
        success: function(response) {
            if (!Array.isArray(response) || response.length === 0) {
                $('#grid-charge-list').html('<tr><td colspan="4" class="text-center">No grid charge settings detected</td></tr>');
                $('#enabled-grid-charge').text('0');
                $('#inverter-count').text('0');
                return;
            }
            
            // Process the settings
            gridChargeSettings = {};
            
            response.forEach(change => {
                if (!change.topic) return;
                
                // Extract inverter information
                const topicParts = change.topic.split('/');
                const inverterPart = topicParts.find(part => part.startsWith('inverter_')) || 'unknown_inverter';
                
                // Check if this is a grid_charge setting or max_grid_charge_current
                if (change.topic.includes('grid_charge') && !change.topic.includes('grid_charge_point')) {
                    // This is the main grid charge setting (enabled/disabled)
                    if (!gridChargeSettings[inverterPart]) {
                        gridChargeSettings[inverterPart] = {};
                    }
                    
                    gridChargeSettings[inverterPart].gridCharge = {
                        value: change.new_value,
                        topic: change.topic,
                        timestamp: change.timestamp || new Date().toISOString()
                    };
                } else if (change.topic.includes('max_grid_charge_current')) {
                    // This is the max grid charge current setting
                    if (!gridChargeSettings[inverterPart]) {
                        gridChargeSettings[inverterPart] = {};
                    }
                    
                    gridChargeSettings[inverterPart].maxCurrent = {
                        value: change.new_value,
                        topic: change.topic,
                        timestamp: change.timestamp || new Date().toISOString()
                    };
                }
            });
            
            // Prepare to render the settings
            const inverterCount = Object.keys(gridChargeSettings).length;
            let enabledCount = 0;
            
            // Count how many inverters have grid charge enabled
            Object.values(gridChargeSettings).forEach(inverter => {
                if (inverter.gridCharge && 
                    (inverter.gridCharge.value === 'Enabled' || 
                     inverter.gridCharge.value === 'enabled' ||
                     inverter.gridCharge.value === '1' ||
                     inverter.gridCharge.value === 'true')) {
                    enabledCount++;
                }
            });
            
            // Update summary
            $('#enabled-grid-charge').text(enabledCount);
            $('#inverter-count').text(inverterCount);
            
            // Render the list
            renderGridChargeList();
        },
        error: function(xhr, status, error) {
            console.error('Error loading grid charge settings:', status, error);
            $('#grid-charge-list').html(`<tr><td colspan="4" class="text-center">Error loading grid charge settings</td></tr>`);
            $('#enabled-grid-charge').text('0');
            $('#inverter-count').text('0');
        }
    });
}

// Load grid charge points from the API
function loadGridChargePoints() {
    $.ajax({
        url: '/api/grid-charge-changes',
        method: 'GET',
        success: function(response) {
            if (!Array.isArray(response) || response.length === 0) {
                $('#charge-points-list').html('<tr><td colspan="4" class="text-center">No grid charge points detected</td></tr>');
                $('#active-charge-points').text('0');
                return;
            }
            
            // Process the charge points
            chargePoints = {};
            const processedTopics = new Set();
            
            response.forEach(change => {
                if (!change.topic) return;
                
                // Check if this is a grid_charge_point setting
                if (change.topic.includes('grid_charge_point_')) {
                    // Extract inverter and point information
                    const topicParts = change.topic.split('/');
                    const inverterPart = topicParts.find(part => part.startsWith('inverter_')) || 'unknown_inverter';
                    
                    // Extract point number
                    const pointMatch = change.topic.match(/grid_charge_point_(\d+)/);
                    if (!pointMatch) return;
                    const pointNumber = pointMatch[1];
                    
                    // Skip if we've already processed this exact topic
                    if (processedTopics.has(change.topic)) return;
                    processedTopics.add(change.topic);
                    
                    // Determine the value - use new_value if available, fallback to other fields
                    // Keep as original format, don't convert to number
                    let value = change.new_value || change.value || change.current_value;
                    
                    // Create nested structure
                    if (!chargePoints[inverterPart]) {
                        chargePoints[inverterPart] = {};
                    }
                    
                    // Store the point details - preserve original value format
                    chargePoints[inverterPart][pointNumber] = {
                        value: value, // Store as-is without conversion
                        topic: change.topic,
                        timestamp: change.timestamp || new Date().toISOString()
                    };
                }
            });
            
            // Count active charge points
            const pointCount = Object.values(chargePoints)
                .reduce((total, inverter) => total + Object.keys(inverter).length, 0);
            
            // Update summary
            $('#active-charge-points').text(pointCount);
            
            // Render the list
            renderChargePointsList();
        },
        error: function(xhr, status, error) {
            console.error('Error loading grid charge points:', status, error);
            $('#charge-points-list').html(`<tr><td colspan="4" class="text-center">Error loading grid charge points</td></tr>`);
            $('#active-charge-points').text('0');
        }
    });
}

// Render the grid charge settings list
function renderGridChargeList() {
    let html = '';
    
    // Check if we have any settings
    if (Object.keys(gridChargeSettings).length === 0) {
        html = `
            <tr>
                <td colspan="4" class="text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    No grid charge settings detected. Settings will appear here as they are discovered from MQTT.
                </td>
            </tr>
        `;
        $('#grid-charge-list').html(html);
        return;
    }
    
    // Sort inverters by ID
    const sortedInverters = Object.keys(gridChargeSettings)
        .sort((a, b) => {
            const aMatch = a.match(/inverter_(\d+)/);
            const bMatch = b.match(/inverter_(\d+)/);
            
            if (aMatch && bMatch) {
                return parseInt(aMatch[1]) - parseInt(bMatch[1]);
            }
            
            return a.localeCompare(b);
        });
    
    // Loop through all inverters
    sortedInverters.forEach(inverter => {
        const settings = gridChargeSettings[inverter];
        const inverterId = inverter;
        const displayName = inverterId !== 'unknown_inverter' ? 
            inverterId.replace('_', ' ').charAt(0).toUpperCase() + inverterId.slice(1) : 
            'Unknown Inverter';
        
        // Determine grid charge status
        let gridChargeStatus = 'Unknown';
        let statusClass = 'bg-secondary';
        let statusIcon = 'fa-question-circle';
        
        if (settings.gridCharge) {
            const value = settings.gridCharge.value;
            if (value === 'Enabled' || value === 'enabled' || value === '1' || value === 'true') {
                gridChargeStatus = 'Enabled';
                statusClass = 'bg-success';
                statusIcon = 'fa-check-circle';
            } else {
                gridChargeStatus = 'Disabled';
                statusClass = 'bg-danger';
                statusIcon = 'fa-times-circle';
            }
        }
        
        // Determine max current
        let maxCurrent = 'Not set';
        if (settings.maxCurrent) {
            maxCurrent = `${settings.maxCurrent.value} A`;
        }
        
        html += `
            <tr>
                <td>${displayName}</td>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas ${statusIcon} status-icon me-2 text-${statusClass.replace('bg-', '')}"></i>
                        <span class="badge ${statusClass}">${gridChargeStatus}</span>
                    </div>
                </td>
                <td>${maxCurrent}</td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary edit-grid-charge" 
                                data-inverter="${inverterId}" 
                                data-type="gridCharge" 
                                data-topic="${settings.gridCharge?.topic || ''}">
                            <i class="fas fa-power-off me-1"></i>Toggle
                        </button>
                        <button class="btn btn-sm btn-outline-secondary edit-max-current" 
                                data-inverter="${inverterId}" 
                                data-type="maxCurrent" 
                                data-topic="${settings.maxCurrent?.topic || ''}">
                            <i class="fas fa-tachometer-alt me-1"></i>Set Current
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    $('#grid-charge-list').html(html);
    
    // Add event listeners to buttons
    $('.edit-grid-charge').click(function() {
        const inverter = $(this).data('inverter');
        const type = $(this).data('type');
        const topic = $(this).data('topic');
        const current = gridChargeSettings[inverter]?.gridCharge?.value || 'Disabled';
        
        openEditModal(inverter, type, current, topic);
    });
    
    $('.edit-max-current').click(function() {
        const inverter = $(this).data('inverter');
        const type = $(this).data('type');
        const topic = $(this).data('topic');
        const current = gridChargeSettings[inverter]?.maxCurrent?.value || '0';
        
        openEditModal(inverter, type, current, topic);
    });
}

// Render the charge points list
function renderChargePointsList() {
    let html = '';
    let foundPoints = false;
    
    // Loop through all inverters
    for (const inverter in chargePoints) {
        const inverterId = inverter;
        const displayName = inverterId !== 'unknown_inverter' ? 
            inverterId.replace('_', ' ').charAt(0).toUpperCase() + inverterId.slice(1) : 
            'Unknown Inverter';
        
        // Check if this inverter has any charge points
        const pointCount = Object.keys(chargePoints[inverter]).length;
        if (pointCount === 0) continue;
        
        foundPoints = true;
        
        // Add inverter header
        html += `<tr class="table-secondary"><th colspan="4">${displayName}</th></tr>`;
        
        // Sort charge points by number
        const sortedPoints = Object.keys(chargePoints[inverter])
            .sort((a, b) => parseInt(a) - parseInt(b));
        
        // Add each charge point
        sortedPoints.forEach((pointNumber) => {
            const point = chargePoints[inverter][pointNumber];
            const pointName = `Grid Charge Point ${pointNumber}`;
            const topicDisplay = point.topic || `${inverter}/grid_charge_point_${pointNumber}/set`;
            
            // Format value as true/false with appropriate badge color
            let displayValue = point.value;
            let badgeClass = 'bg-primary';
            
            if (displayValue === 'true' || displayValue === true || 
                displayValue === '1' || displayValue === 1 ||
                displayValue === 'Enabled' || displayValue === 'enabled') {
                displayValue = 'true';
                badgeClass = 'bg-success';
            } else {
                displayValue = 'false';
                badgeClass = 'bg-danger';
            }
            
            html += `
                <tr data-inverter="${inverter}" data-point="${pointNumber}" data-value="${point.value}" data-topic="${topicDisplay}">
                    <td>
                        <div class="d-flex flex-column">
                            <strong>${pointName}</strong>
                            <small class="text-muted topic-display">${topicDisplay}</small>
                        </div>
                    </td>
                    <td><span class="badge ${badgeClass}">${displayValue}</span></td>
                    <td>
                        <span class="timestamp">
                            <i class="fas fa-clock me-1"></i>
                            ${moment(point.timestamp).format('MM/DD HH:mm')}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-charge-point">
                            <i class="fas fa-edit me-1"></i>Edit
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    if (!foundPoints) {
        html = `
            <tr>
                <td colspan="4" class="text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    No grid charge points detected. Points will appear here as they are discovered from MQTT.
                </td>
            </tr>
        `;
    }
    
    $('#charge-points-list').html(html);
    
    // Add click handler to edit buttons
    $('.edit-charge-point').click(function() {
        const row = $(this).closest('tr');
        const inverter = row.data('inverter');
        const point = row.data('point');
        const value = row.data('value');
        const topic = row.data('topic');
        
        openEditModal(inverter, 'chargePoint', value, topic, point);
    });
}

// Load recent changes
function loadRecentChanges() {
    $.ajax({
        url: '/api/grid-charge-changes',
        method: 'GET',
        success: function(response) {
            displayRecentChanges(response);
        },
        error: function() {
            $('#recent-changes').html('<div class="alert alert-warning">Failed to load recent changes</div>');
        }
    });
}

// Display recent changes
function displayRecentChanges(changes) {
    if (!changes || changes.length === 0) {
        $('#recent-changes').html('<div class="text-center p-3">No recent changes found</div>');
        return;
    }
    
    // Sort changes by timestamp (newest first)
    changes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    // Take only the 10 most recent changes
    const recentChanges = changes.slice(0, 10);
    
    let html = '';
    
    recentChanges.forEach(change => {
        const timestamp = moment(change.timestamp).format('MM/DD HH:mm');
        const topicParts = change.topic.split('/');
        let settingName = 'Unknown Setting';
        
        // Try to identify the type of setting
        if (change.topic.includes('grid_charge_point_')) {
            // This is a grid charge point
            const pointMatch = change.topic.match(/grid_charge_point_(\d+)/);
            if (pointMatch) {
                settingName = `Grid Charge Point ${pointMatch[1]}`;
            }
        } else if (change.topic.includes('max_grid_charge_current')) {
            settingName = 'Max Grid Charge Current';
        } else if (change.topic.includes('grid_charge')) {
            settingName = 'Grid Charge Status';
        }
        
        // Extract inverter from topic
        let inverter = 'unknown';
        for (const part of topicParts) {
            if (part.includes('inverter_')) {
                inverter = part;
                break;
            }
        }
        
        const inverterDisplay = inverter !== 'unknown' ? 
            inverter.replace('_', ' ').charAt(0).toUpperCase() + inverter.slice(1).replace('_', ' ') : 
            'Unknown';
        
        // Format the value based on the setting type
        let valueDisplay = change.new_value;
        let valueClass = 'bg-primary';
        
        if (settingName.includes('Grid Charge Point')) {
            if (valueDisplay === 'true' || valueDisplay === true || valueDisplay === '1' || 
                valueDisplay === 'Enabled' || valueDisplay === 'enabled') {
                valueDisplay = 'true';
                valueClass = 'bg-success';
            } else {
                valueDisplay = 'false';
                valueClass = 'bg-danger';
            }
        } else if (settingName === 'Grid Charge Status') {
            if (valueDisplay === 'Enabled' || valueDisplay === 'enabled' || valueDisplay === '1' || valueDisplay === 'true') {
                valueDisplay = 'Enabled';
                valueClass = 'bg-success';
            } else {
                valueDisplay = 'Disabled';
                valueClass = 'bg-danger';
            }
        } else if (settingName === 'Max Grid Charge Current') {
            valueDisplay = `${valueDisplay} A`;
        }
        
        html += `
            <div class="p-2 border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">${settingName}</div>
                        <div class="text-muted small">${inverterDisplay}</div>
                    </div>
                    <div class="text-end">
                        <div>${timestamp}</div>
                        <div class="badge ${valueClass}">${valueDisplay}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    $('#recent-changes').html(html);
}

// Load grid charge history
function loadGridChargeHistory() {
    $.ajax({
        url: '/api/grid-charge-changes',
        method: 'GET',
        success: function(response) {
            displayGridChargeHistory(response);
        },
        error: function() {
            $('#grid-history-list').html('<tr><td colspan="4" class="text-center">Failed to load history</td></tr>');
        }
    });
}

// Display grid charge history
function displayGridChargeHistory(changes) {
    if (!changes || changes.length === 0) {
        $('#grid-history-list').html('<tr><td colspan="4" class="text-center">No history found</td></tr>');
        return;
    }
    
    // Sort changes by timestamp (newest first)
    changes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    let html = '';
    
    changes.forEach(change => {
        const timestamp = moment(change.timestamp).format('MM/DD/YYYY HH:mm:ss');
        
        // Identify the setting type
        let settingDisplay = change.topic;
        if (change.topic.includes('grid_charge_point_')) {
            const pointMatch = change.topic.match(/grid_charge_point_(\d+)/);
            if (pointMatch) {
                settingDisplay = `Grid Charge Point ${pointMatch[1]}`;
            }
        } else if (change.topic.includes('max_grid_charge_current')) {
            settingDisplay = 'Max Grid Charge Current';
        } else if (change.topic.includes('grid_charge')) {
            settingDisplay = 'Grid Charge Status';
        }
        
        // Format the old and new values
        let oldValue = change.old_value || '--';
        let newValue = change.new_value || '--';
        
        if (settingDisplay.includes('Grid Charge Point')) {
            // Convert to true/false for grid charge points
            if (oldValue === 'Enabled' || oldValue === 'enabled' || oldValue === '1' || oldValue === 'true') {
                oldValue = 'true';
            } else if (oldValue !== '--') {
                oldValue = 'false';
            }
            
            if (newValue === 'Enabled' || newValue === 'enabled' || newValue === '1' || newValue === 'true') {
                newValue = 'true';
            } else {
                newValue = 'false';
            }
        } else if (settingDisplay === 'Grid Charge Status') {
            // Keep Enabled/Disabled for grid charge status
            if (oldValue === 'Enabled' || oldValue === 'enabled' || oldValue === '1' || oldValue === 'true') {
                oldValue = 'Enabled';
            } else if (oldValue !== '--') {
                oldValue = 'Disabled';
            }
            
            if (newValue === 'Enabled' || newValue === 'enabled' || newValue === '1' || newValue === 'true') {
                newValue = 'Enabled';
            } else {
                newValue = 'Disabled';
            }
        } else if (settingDisplay === 'Max Grid Charge Current') {
            if (oldValue !== '--') oldValue = `${oldValue} A`;
            newValue = `${newValue} A`;
        }
        
        html += `
            <tr>
                <td>${timestamp}</td>
                <td>${settingDisplay}</td>
                <td>${oldValue}</td>
                <td>${newValue}</td>
            </tr>
        `;
    });
    
    $('#grid-history-list').html(html);
}

// Open the edit modal for a setting
function openEditModal(inverter, type, currentValue, topic, pointNumber = null) {
    // Set hidden fields
    $('#edit-inverter').val(inverter);
    $('#edit-setting-type').val(type);
    
    // Reset all containers (hide them initially)
    $('#toggle-container').hide();
    $('#current-container').hide();
    $('#point-container').hide();
    
    // Set up the modal based on the setting type
    if (type === 'gridCharge') {
        // Grid charge status (toggle)
        $('#setting-name-display').text('Grid Charge Status');
        $('#toggle-container').show();
        
        // Set the toggle state
        const isEnabled = currentValue === 'Enabled' || currentValue === 'enabled' || 
                          currentValue === '1' || currentValue === 'true';
        $('#grid-charge-toggle').prop('checked', isEnabled);
        $('#toggle-label').text(isEnabled ? 'Grid Charge Enabled' : 'Grid Charge Disabled');
        
        // Display current value
        $('#current-value-display').text(isEnabled ? 'Enabled' : 'Disabled');
        
    } else if (type === 'maxCurrent') {
        // Max grid charge current (numeric input)
        $('#setting-name-display').text('Max Grid Charge Current');
        $('#current-container').show();
        
        // Set the current value
        $('#edit-current').val(currentValue);
        
        // Display current value
        $('#current-value-display').text(`${currentValue} A`);
        
    } else if (type === 'chargePoint') {
        // Grid charge point (toggle switch for true/false)
        $('#setting-name-display').text(`Grid Charge Point ${pointNumber}`);
        $('#toggle-container').show(); // Use the toggle container for charge points too
        
        // Set the toggle state - convert any representation to boolean
        const isTrue = currentValue === 'true' || currentValue === true || 
                       currentValue === '1' || currentValue === 1 ||
                       currentValue === 'Enabled' || currentValue === 'enabled';
        $('#grid-charge-toggle').prop('checked', isTrue);
        $('#toggle-label').text(isTrue ? 'true' : 'false');
        
        // Display current value
        $('#current-value-display').text(isTrue ? 'true' : 'false');
    }
    
    // Set inverter display
    const inverterDisplay = inverter !== 'unknown_inverter' ? 
        inverter.replace('_', ' ').charAt(0).toUpperCase() + inverter.slice(1).replace('_', ' ') : 
        'Unknown Inverter';
    
    $('#setting-inverter-display').text(inverterDisplay);
    
    // Set topic display
    if (topic) {
        $('#setting-topic-display').text(topic);
    } else {
        // Construct a default topic if not provided
        if (type === 'gridCharge') {
            $('#setting-topic-display').text(`${mqttTopicPrefix}/${inverter}/grid_charge/set`);
        } else if (type === 'maxCurrent') {
            $('#setting-topic-display').text(`${mqttTopicPrefix}/${inverter}/max_grid_charge_current/set`);
        } else if (type === 'chargePoint') {
            $('#setting-topic-display').text(`${mqttTopicPrefix}/${inverter}/grid_charge_point_${pointNumber}/set`);
        }
    }
    
    // Update toggle label when toggle changes
    $('#grid-charge-toggle').change(function() {
        if (type === 'chargePoint') {
            $('#toggle-label').text($(this).is(':checked') ? 'true' : 'false');
        } else {
            $('#toggle-label').text($(this).is(':checked') ? 'Grid Charge Enabled' : 'Grid Charge Disabled');
        }
    });
    
    // Show the modal
    const editModal = new bootstrap.Modal(document.getElementById('editGridChargeModal'));
    editModal.show();
}

// Save the grid charge setting
function saveGridChargeSetting() {
    const inverter = $('#edit-inverter').val();
    const type = $('#edit-setting-type').val();
    let topic = $('#setting-topic-display').text();
    let value;
    
    // Get the value based on the setting type
    if (type === 'gridCharge') {
        value = $('#grid-charge-toggle').is(':checked') ? 'Enabled' : 'Disabled';
    } else if (type === 'maxCurrent') {
        value = $('#edit-current').val();
    } else if (type === 'chargePoint') {
        // For charge points, use true/false values
        value = $('#grid-charge-toggle').is(':checked') ? 'true' : 'false';
    }
    
    // Validate input
    if (value === undefined || value === '') {
        showAlert('warning', 'Please enter a valid value', true);
        return;
    }
    
    // Ensure the topic ends with /set
    if (!topic.endsWith('/set')) {
        topic = topic.replace('/state', '/set');
        if (!topic.endsWith('/set')) {
            topic = `${topic}/set`;
        }
    }
    
    // Send to server
    $.ajax({
        url: '/api/command',
        method: 'POST',
        data: {
            topic: topic,
            value: value
        },
        success: function(response) {
            if (response.success) {
                // Hide the modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editGridChargeModal'));
                editModal.hide();
                
                // Show success message
                let settingDisplay = 'Setting';
                if (type === 'gridCharge') {
                    settingDisplay = 'Grid Charge Status';
                } else if (type === 'maxCurrent') {
                    settingDisplay = 'Max Grid Charge Current';
                } else if (type === 'chargePoint') {
                    settingDisplay = 'Grid Charge Point';
                }
                
                showAlert('success', `${settingDisplay} updated successfully`);
                
                // Update our local data
                if (type === 'gridCharge') {
                    if (!gridChargeSettings[inverter]) {
                        gridChargeSettings[inverter] = {};
                    }
                    
                    gridChargeSettings[inverter].gridCharge = {
                        value: value,
                        topic: topic,
                        timestamp: new Date()
                    };
                    
                    // Re-render the grid charge list
                    renderGridChargeList();
                    
                } else if (type === 'maxCurrent') {
                    if (!gridChargeSettings[inverter]) {
                        gridChargeSettings[inverter] = {};
                    }
                    
                    gridChargeSettings[inverter].maxCurrent = {
                        value: value,
                        topic: topic,
                        timestamp: new Date()
                    };
                    
                    // Re-render the grid charge list
                    renderGridChargeList();
                    
                } else if (type === 'chargePoint') {
                    const pointNumber = topic.match(/grid_charge_point_(\d+)/)[1];
                    
                    if (!chargePoints[inverter]) {
                        chargePoints[inverter] = {};
                    }
                    
                    chargePoints[inverter][pointNumber] = {
                        value: value, // Store the true/false value directly
                        topic: topic,
                        timestamp: new Date()
                    };
                    
                    // Re-render the charge points list
                    renderChargePointsList();
                }
                
                // Refresh data after a short delay
                setTimeout(() => {
                    loadGridChargeSettings();
                    loadGridChargePoints();
                    loadRecentChanges();
                }, 2000);
                
            } else {
                showAlert('danger', `Failed to update setting: ${response.message || 'Unknown error'}`, true);
            }
        },
        error: function(error) {
            showAlert('danger', `Error updating setting: ${error.responseJSON?.error || 'Server error'}`, true);
        }
    });
}

// Open the Add Charge Point modal
function openAddChargePointModal() {
    // Populate the inverter dropdown
    $('#new-inverter').empty();
    
    // Get all available inverters
    const inverters = Object.keys(gridChargeSettings);
    if (inverters.length === 0) {
        // If no inverters are found in gridChargeSettings, check chargePoints
        Object.keys(chargePoints).forEach(inverter => {
            if (!inverters.includes(inverter)) {
                inverters.push(inverter);
            }
        });
    }
    
    // Sort inverters
    inverters.sort((a, b) => {
        const aMatch = a.match(/inverter_(\d+)/);
        const bMatch = b.match(/inverter_(\d+)/);
        
        if (aMatch && bMatch) {
            return parseInt(aMatch[1]) - parseInt(bMatch[1]);
        }
        
        return a.localeCompare(b);
    });
    
    // Add inverters to dropdown
    inverters.forEach(inverter => {
        const displayName = inverter !== 'unknown_inverter' ? 
            inverter.replace('_', ' ').charAt(0).toUpperCase() + inverter.slice(1) : 
            'Unknown Inverter';
        
        $('#new-inverter').append(`<option value="${inverter}">${displayName}</option>`);
    });
    
    // Update the form to use a toggle instead of numeric input
    const pointValueHtml = `
        <div class="mb-3">
            <label class="form-label">Point Status</label>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="new-point-toggle" checked>
                <label class="form-check-label" for="new-point-toggle" id="new-point-toggle-label">true</label>
            </div>
        </div>
    `;
    
    // Replace the numeric input with toggle
    if ($('#new-point-value').closest('.mb-3').length) {
        $('#new-point-value').closest('.mb-3').replaceWith(pointValueHtml);
    } else {
        // If it doesn't exist yet, append
        $('#new-point-number').closest('.mb-3').after(pointValueHtml);
    }
    
    // Add event handler for toggle
    $('#new-point-toggle').change(function() {
        $('#new-point-toggle-label').text($(this).is(':checked') ? 'true' : 'false');
    });
    
    // Show the modal
    const addModal = new bootstrap.Modal(document.getElementById('addChargePointModal'));
    addModal.show();
}

// Save new charge point
function saveNewChargePoint() {
    const inverter = $('#new-inverter').val();
    const pointNumber = $('#new-point-number').val();
    const isTrue = $('#new-point-toggle').is(':checked');
    const value = isTrue ? 'true' : 'false'; // Use true/false values
    
    // Validate input
    if (!inverter || !pointNumber || pointNumber < 1) {
        showAlert('warning', 'Please enter valid values for all fields', true);
        return;
    }
    
    // Construct topic
    const topic = `${mqttTopicPrefix}/${inverter}/grid_charge_point_${pointNumber}/set`;
    
    // Send to server
    $.ajax({
        url: '/api/command',
        method: 'POST',
        data: {
            topic: topic,
            value: value
        },
        success: function(response) {
            if (response.success) {
                // Hide the modal
                const addModal = bootstrap.Modal.getInstance(document.getElementById('addChargePointModal'));
                addModal.hide();
                
                // Show success message
                showAlert('success', `Grid Charge Point ${pointNumber} created successfully`);
                
                // Update our local data
                if (!chargePoints[inverter]) {
                    chargePoints[inverter] = {};
                }
                
                chargePoints[inverter][pointNumber] = {
                    value: value,
                    topic: topic,
                    timestamp: new Date()
                };
                
                // Re-render the charge points list
                renderChargePointsList();
                
                // Update point count
                const pointCount = Object.values(chargePoints)
                    .reduce((total, inverter) => total + Object.keys(inverter).length, 0);
                $('#active-charge-points').text(pointCount);
                
                // Refresh data after a short delay
                setTimeout(() => {
                    loadGridChargePoints();
                    loadRecentChanges();
                }, 2000);
                
            } else {
                showAlert('danger', `Failed to create charge point: ${response.message || 'Unknown error'}`, true);
            }
        },
        error: function(error) {
            showAlert('danger', `Error creating charge point: ${error.responseJSON?.error || 'Server error'}`, true);
        }
    });
}

// Show alert
function showAlert(type, message, inModal = false) {
    const alertId = 'alert-' + Date.now();
    const alertHtml = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    if (inModal) {
        // Insert at the top of the modal body
        $('#editGridChargeModal .modal-body').prepend(alertHtml);
    } else {
        // Insert at the top of the alerts container
        $('#alerts-container').prepend(alertHtml);
    }
    
    // Automatically remove alert after 5 seconds
    setTimeout(() => {
        $(`#${alertId}`).alert('close');
    }, 5000);
}
</script>
</body>
</html>
