<!-- energy-pattern.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy System - Energy Pattern Settings</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border-radius: 8px;
            border: none;
        }
        .card-header {
            background-color: #f1f8ff;
            border-bottom: 1px solid #e3f2fd;
            border-radius: 8px 8px 0 0 !important;
        }
        .change-item {
            cursor: pointer;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .change-item:hover {
            background-color: #f8f9fa;
        }
        .change-item:last-child {
            border-bottom: none;
        }
        .change-value {
            font-weight: 500;
        }
        .inverter-heading {
            background-color: #e9ecef;
            padding: 10px 15px;
            font-weight: 600;
            margin-top: 15px;
            border-radius: 5px;
        }
        .modal-header {
            background-color: #f1f8ff;
        }
        .timestamp {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .setting-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .edit-icon {
            color: #007bff;
            opacity: 0.7;
        }
        .change-item:hover .edit-icon {
            opacity: 1;
        }
        .nav-link.active {
            font-weight: bold;
            color: #007bff !important;
        }
        .changes-list {
            max-height: 500px;
            overflow-y: auto;
        }
        .pattern-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .pattern-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        .pattern-card.active {
            border: 2px solid #007bff;
        }
        .pattern-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .pattern-option {
            margin-bottom: 15px;
        }
        .system-stat {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        .chart-container {
            height: 250px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-solar-panel me-2"></i>Energy System Monitor</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/grid-charge"><i class="fas fa-plug me-1"></i>Grid Charge</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/energy-pattern"><i class="fas fa-battery-three-quarters me-1"></i>Energy Pattern</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/work-mode"><i class="fas fa-cogs me-1"></i>Work Mode</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/battery-charging"><i class="fas fa-charging-station me-1"></i>Battery Charging</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/voltage-point"><i class="fas fa-bolt me-1"></i>Voltage Points</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/rules"><i class="fas fa-tasks me-1"></i>Rules</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/learner"><i class="fas fa-brain me-1"></i>Learner</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Alerts container -->
        <div id="alerts-container"></div>

        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-battery-three-quarters me-2"></i>Energy Pattern</h5>
                        <div>
                            <button class="btn btn-outline-primary me-2" id="view-history-btn">
                                <i class="fas fa-history me-1"></i> View History
                            </button>
                            <button class="btn btn-primary" id="refresh-patterns">
                                <i class="fas fa-sync-alt me-1"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Energy pattern controls how your system prioritizes different energy sources. Choose the pattern that best fits your current needs.
                        </div>
                        
                        <div id="inverters-container">
                            <!-- Inverters will be loaded here -->
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <div class="mt-2">Loading inverters...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Energy Pattern Impact</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            This chart shows how your energy pattern choices affect your battery state of charge over time.
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="patternImpactChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="system-stat">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-battery-half me-2"></i>Battery SoC:</span>
                                <span id="battery-soc" class="text-primary fw-bold">--</span>
                            </div>
                        </div>
                        
                        <div class="system-stat">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-solar-panel me-2"></i>PV Power:</span>
                                <span id="pv-power" class="text-success fw-bold">--</span>
                            </div>
                        </div>
                        
                        <div class="system-stat">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-plug me-2"></i>Grid Power:</span>
                                <span id="grid-power" class="text-danger fw-bold">--</span>
                            </div>
                        </div>
                        
                        <div class="system-stat">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-bolt me-2"></i>Load:</span>
                                <span id="load-power" class="text-warning fw-bold">--</span>
                            </div>
                        </div>
                        
                        <p class="text-muted mt-3 small">
                            <i class="fas fa-clock me-1"></i> Last updated: <span id="last-updated">--</span>
                        </p>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Changes</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="changes-list" id="recent-changes">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <div class="mt-2">Loading recent changes...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Energy Pattern History Modal -->
    <div class="modal fade" id="patternHistoryModal" tabindex="-1" aria-labelledby="patternHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="patternHistoryModalLabel">Energy Pattern Change History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">Filter by Inverter</span>
                                <select class="form-select" id="history-inverter-filter">
                                    <option value="all">All Inverters</option>
                                    <!-- Inverter options will be added dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">Time Range</span>
                                <select class="form-select" id="history-time-range">
                                    <option value="24">Last 24 Hours</option>
                                    <option value="48">Last 48 Hours</option>
                                    <option value="168" selected>Last 7 Days</option>
                                    <option value="720">Last 30 Days</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Inverter</th>
                                    <th>Old Pattern</th>
                                    <th>New Pattern</th>
                                    <th>Battery SoC</th>
                                </tr>
                            </thead>
                            <tbody id="pattern-history-list">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <div class="mt-2">Loading history...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    
    <script>
        // Global variables
        let inverters = [];
        let currentPatterns = {};
        let systemState = {};
        let patternImpactChart = null;
        
        // Pattern descriptions for tooltips
        const patternDescriptions = {
            'Battery first': 'Uses battery power first, then grid. Good for maximizing self-consumption.',
            'Grid first': 'Uses grid power first, preserving battery for backup. Good for keeping battery fully charged.',
            'Solar first': 'Prioritizes solar power usage, using grid/battery as needed. Maximizes solar utilization.',
            'Solar + Battery': 'Uses solar and battery before grid. Best for grid independence.',
            'Solar + Grid': 'Combines solar with grid power to meet loads while charging battery. Good for maintaining battery health.'
        };
        
        // Pattern icons and colors
        const patternIcons = {
            'Battery first': 'fa-battery-full',
            'Grid first': 'fa-plug',
            'Solar first': 'fa-solar-panel',
            'Solar + Battery': 'fa-sun',
            'Solar + Grid': 'fa-bolt'
        };
        
        const patternColors = {
            'Battery first': '#28a745',
            'Grid first': '#dc3545',
            'Solar first': '#fd7e14',
            'Solar + Battery': '#17a2b8',
            'Solar + Grid': '#6610f2'
        };
        
        // Initialize the page
        $(document).ready(function() {
            // Load current patterns and system state
            loadCurrentPatterns();
            
            // Load system state
            loadSystemState();
            
            // Load recent changes
            loadRecentChanges();
            
            // Initialize chart
            initializeChart();
            
            // Set up event listeners
            setupEventListeners();
            
            // Refresh data every 30 seconds
            setInterval(function() {
                loadSystemState();
            }, 30000);
        });
        
        // Setup event listeners
        function setupEventListeners() {
            // Refresh button
            $('#refresh-patterns').click(function() {
                loadCurrentPatterns();
                loadSystemState();
                showAlert('info', 'Energy patterns refreshed');
            });
            
            // View history button
            $('#view-history-btn').click(function() {
                loadPatternHistory();
                const historyModal = new bootstrap.Modal(document.getElementById('patternHistoryModal'));
                historyModal.show();
            });
            
            // History filter change
            $('#history-inverter-filter, #history-time-range').change(function() {
                loadPatternHistory();
            });
        }
        
        // Load current patterns from the API
        function loadCurrentPatterns() {
            $.ajax({
                url: '/api/current-settings',
                method: 'GET',
                success: function(response) {
                    if (response && response.success) {
                        // Process inverters and their patterns
                        const inverterCount = response.inverterCount || 1;
                        inverters = [];
                        currentPatterns = {};
                        
                        // Create inverter list
                        for (let i = 1; i <= inverterCount; i++) {
                            const inverterId = `inverter_${i}`;
                            inverters.push(inverterId);
                            
                            // Extract current pattern if available
                            const currentPattern = response.currentSettings?.energy_pattern?.[inverterId] || 'Unknown';
                            currentPatterns[inverterId] = currentPattern;
                        }
                        
                        // Render the inverters and their patterns
                        renderInverters();
                    } else {
                        showAlert('warning', 'Failed to load current patterns');
                        $('#inverters-container').html('<div class="alert alert-warning">Error loading energy patterns</div>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading current patterns:', status, error);
                    showAlert('danger', 'Error connecting to server');
                    $('#inverters-container').html('<div class="alert alert-danger">Server connection error</div>');
                }
            });
        }
        
        // Load system state
        function loadSystemState() {
            $.ajax({
                url: '/api/system-state',
                method: 'GET',
                success: function(response) {
                    if (response && response.current_state) {
                        systemState = response.current_state;
                        
                        // Update UI with system state
                        $('#battery-soc').text(systemState.battery_soc !== null ? systemState.battery_soc + '%' : '--');
                        $('#pv-power').text(systemState.pv_power !== null ? systemState.pv_power + 'W' : '--');
                        $('#grid-power').text(systemState.grid_power !== null ? systemState.grid_power + 'W' : '--');
                        $('#load-power').text(systemState.load !== null ? systemState.load + 'W' : '--');
                        $('#last-updated').text(moment(systemState.timestamp).format('MM/DD HH:mm:ss'));
                        
                        // Update battery icon based on SOC
                        updateBatteryIcon(systemState.battery_soc);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading system state:', status, error);
                }
            });
        }
        
        // Update battery icon based on state of charge
        function updateBatteryIcon(soc) {
            let iconClass = 'fa-battery-empty';
            
            if (soc === null || soc === undefined) {
                // No data
                iconClass = 'fa-battery-empty';
            } else if (soc >= 90) {
                iconClass = 'fa-battery-full';
            } else if (soc >= 70) {
                iconClass = 'fa-battery-three-quarters';
            } else if (soc >= 40) {
                iconClass = 'fa-battery-half';
            } else if (soc >= 10) {
                iconClass = 'fa-battery-quarter';
            }
            
            // Update the icon
            $('#battery-soc').prev().find('i').removeClass().addClass(`fas ${iconClass} me-2`);
        }
        
        // Render the inverters and their patterns
        function renderInverters() {
            let html = '';
            
            if (inverters.length === 0) {
                html = '<div class="alert alert-warning">No inverters detected</div>';
            } else {
                // For each inverter
                inverters.forEach((inverterId, index) => {
                    const inverterNumber = index + 1;
                    const currentPattern = currentPatterns[inverterId] || 'Unknown';
                    
                    html += `
                        <div class="mb-4">
                            <div class="inverter-heading mb-3">
                                <i class="fas fa-microchip me-2"></i>Inverter ${inverterNumber}
                                <span class="badge bg-primary ms-2">
                                    Current: ${currentPattern}
                                </span>
                            </div>
                            
                            <div class="row" id="patterns-${inverterId}">
                                <!-- Pattern options -->
                                ${renderPatternOptions(inverterId, currentPattern)}
                            </div>
                        </div>
                    `;
                });
            }
            
            $('#inverters-container').html(html);
            
            // Add click handlers to pattern cards
            $('.pattern-card').click(function() {
                const inverterId = $(this).data('inverter');
                const pattern = $(this).data('pattern');
                
                // Set the new pattern
                setEnergyPattern(inverterId, pattern);
            });
            
            // Initialize tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();
        }
        
        // Render pattern options for an inverter
        function renderPatternOptions(inverterId, currentPattern) {
            const patterns = [
                'Battery first',
                'Grid first',
                'Solar first',
                'Solar + Battery',
                'Solar + Grid'
            ];
            
            let html = '';
            
            patterns.forEach(pattern => {
                const isActive = pattern === currentPattern;
                const icon = patternIcons[pattern] || 'fa-question';
                const color = patternColors[pattern] || '#6c757d';
                const description = patternDescriptions[pattern] || 'No description available';
                
                html += `
                    <div class="col-md-4 col-sm-6 pattern-option">
                        <div class="card pattern-card ${isActive ? 'active' : ''}" 
                             data-inverter="${inverterId}" 
                             data-pattern="${pattern}"
                             data-bs-toggle="tooltip"
                             data-bs-placement="top"
                             title="${description}">
                            <div class="card-body text-center">
                                <i class="fas ${icon} pattern-icon" style="color: ${color};"></i>
                                <h5 class="card-title">${pattern}</h5>
                                <p class="card-text small">${description.substring(0, 60)}${description.length > 60 ? '...' : ''}</p>
                                ${isActive ? 
                                    '<div class="mt-2 badge bg-success">Current Setting</div>' : 
                                    '<div class="mt-2 text-muted small">Click to select</div>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        // Set energy pattern
        function setEnergyPattern(inverterId, pattern) {
            $.ajax({
                url: '/api/command',
                method: 'POST',
                data: {
                    topic: `energy/${inverterId}/energy_pattern/set`,
                    value: pattern
                },
                success: function(response) {
                    if (response.success) {
                        // Update local data
                        currentPatterns[inverterId] = pattern;
                        
                        // Update UI
                        $(`#patterns-${inverterId} .pattern-card`).removeClass('active');
                        $(`#patterns-${inverterId} .pattern-card[data-pattern="${pattern}"]`).addClass('active');
                        
                        // Update the badge
                        $(`.inverter-heading:contains("Inverter ${inverterId.split('_')[1]}") .badge`).text(`Current: ${pattern}`);
                        
                        // Show success message
                        showAlert('success', `Energy pattern for Inverter ${inverterId.split('_')[1]} set to ${pattern}`);
                        
                        // Refresh data after a short delay
                        setTimeout(() => {
                            loadRecentChanges();
                            loadSystemState();
                        }, 2000);
                    } else {
                        showAlert('danger', `Failed to set energy pattern: ${response.message || 'Unknown error'}`);
                    }
                },
                error: function(error) {
                    console.error('Error setting energy pattern:', error);
                    showAlert('danger', `Error setting energy pattern: ${error.responseJSON?.error || 'Server error'}`);
                }
            });
        }
        
        // Load recent changes
        function loadRecentChanges() {
            $.ajax({
                url: '/api/energy-pattern-changes',
                method: 'GET',
                success: function(response) {
                    displayRecentChanges(response);
                },
                error: function() {
                    $('#recent-changes').html('<div class="alert alert-warning m-3">Failed to load recent changes</div>');
                }
            });
        }
        
        // Display recent changes
        function displayRecentChanges(changes) {
            if (!changes || changes.length === 0) {
                $('#recent-changes').html('<div class="text-center p-3">No recent changes found</div>');
                return;
            }
            
            // Sort changes by timestamp (newest first)
            changes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Take only the 10 most recent changes
            const recentChanges = changes.slice(0, 10);
            
            let html = '';
            
            recentChanges.forEach(change => {
                const timestamp = moment(change.timestamp).format('MM/DD HH:mm');
                const topicParts = change.topic.split('/');
                
                // Extract inverter from topic
                let inverter = 'unknown';
                for (const part of topicParts) {
                    if (part.includes('inverter_')) {
                        inverter = part;
                        break;
                    }
                }
                
                const inverterDisplay = inverter !== 'unknown' ? 
                    `Inverter ${inverter.replace('inverter_', '')}` : 
                    'Unknown';
                
                const oldValue = change.old_value || '-';
                const newValue = change.new_value || '-';
                
                // Determine color based on pattern
                const newPatternColor = patternColors[newValue] || '#6c757d';
                
                html += `
                    <div class="change-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold">${inverterDisplay}</div>
                                <div class="small text-muted">${timestamp}</div>
                            </div>
                            <div class="text-end">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">${oldValue}</span>
                                    <i class="fas fa-arrow-right text-muted mx-1"></i>
                                    <span class="badge" style="background-color: ${newPatternColor}">${newValue}</span>
                                </div>
                                <div class="small text-muted mt-1">
                                    Battery: ${change.system_state?.battery_soc || '-'}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            $('#recent-changes').html(html);
        }
        
        // Load pattern history
        function loadPatternHistory() {
            // Get filter values
            const inverterFilter = $('#history-inverter-filter').val();
            const timeRange = $('#history-time-range').val();
            
            // Show loading spinner
            $('#pattern-history-list').html(`
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <div class="mt-2">Loading history...</div>
                    </td>
                </tr>
            `);
            
            // Make API request
            $.ajax({
                url: '/api/energy-pattern-changes',
                method: 'GET',
                data: {
                    hours: timeRange,
                    inverter: inverterFilter === 'all' ? null : inverterFilter
                },
                success: function(response) {
                    displayPatternHistory(response, inverterFilter);
                },
                error: function() {
                    $('#pattern-history-list').html('<tr><td colspan="5" class="text-center">Failed to load history</td></tr>');
                }
            });
        }
        
        // Display pattern history
        function displayPatternHistory(changes, inverterFilter) {
            if (!changes || changes.length === 0) {
                $('#pattern-history-list').html('<tr><td colspan="5" class="text-center">No history found</td></tr>');
                return;
            }
            
            // Sort changes by timestamp (newest first)
            changes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Filter by inverter if needed
            if (inverterFilter && inverterFilter !== 'all') {
                changes = changes.filter(change => change.topic.includes(inverterFilter));
            }
            
            let html = '';
            
            changes.forEach(change => {
                const timestamp = moment(change.timestamp).format('MM/DD/YYYY HH:mm:ss');
                const topicParts = change.topic.split('/');
                
                // Extract inverter from topic
                let inverter = 'unknown';
                for (const part of topicParts) {
                    if (part.includes('inverter_')) {
                        inverter = part;
                        break;
                    }
                }
                
                const inverterDisplay = inverter !== 'unknown' ? 
                    `Inverter ${inverter.replace('inverter_', '')}` : 
                    'Unknown';
                
                const oldValue = change.old_value || '-';
                const newValue = change.new_value || '-';
                const batterySoc = change.system_state?.battery_soc || '-';
                
                html += `
                    <tr>
                        <td>${timestamp}</td>
                        <td>${inverterDisplay}</td>
                        <td><span class="badge bg-secondary">${oldValue}</span></td>
                        <td><span class="badge" style="background-color: ${patternColors[newValue] || '#6c757d'}">${newValue}</span></td>
                        <td>${batterySoc}%</td>
                    </tr>
                `;
            });
            
            $('#pattern-history-list').html(html);
            
            // Update filter options if needed
            if ($('#history-inverter-filter option').length <= 1) {
                // Add inverter options to filter dropdown
                let inverterOptions = '<option value="all">All Inverters</option>';
                inverters.forEach((inverterId, index) => {
                    inverterOptions += `<option value="${inverterId}">Inverter ${index + 1}</option>`;
                });
                $('#history-inverter-filter').html(inverterOptions);
            }
        }
        
        // Initialize the chart
        function initializeChart() {
            const ctx = document.getElementById('patternImpactChart').getContext('2d');
            
            patternImpactChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Battery SoC',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Battery SoC (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    // Add pattern info in tooltip if available
                                    const index = context.dataIndex;
                                    if (index < patternEvents.length) {
                                        return `Pattern: ${patternEvents[index] || 'Unknown'}`;
                                    }
                                    return '';
                                }
                            }
                        },
                        annotation: {
                            annotations: []
                        }
                    }
                }
            });
            
            // Load chart data on initialization
            loadChartData();
        }
        
        // Load chart data
        function loadChartData() {
            $.ajax({
                url: '/api/settings-history/energy_pattern',
                method: 'GET',
                data: {
                    days: 2 // Get last 2 days of data
                },
                success: function(response) {
                    updateChart(response);
                },
                error: function(error) {
                    console.error('Error loading chart data:', error);
                }
            });
        }
        
        // Update the chart with new data
        function updateChart(response) {
            if (!response || !response.data || response.data.length === 0) {
                return;
            }
            
            // Extract timestamps and SoC values
            const timestamps = [];
            const socValues = [];
            const patternEvents = [];
            
            // Get pattern changes and associated SoC
            response.data.forEach(item => {
                if (item.system_state && item.system_state.battery_soc !== null) {
                    // Add data point
                    timestamps.push(moment(item.timestamp).format('MM/DD HH:mm'));
                    socValues.push(item.system_state.battery_soc);
                    patternEvents.push(item.new_value);
                }
            });
            
            // If no valid data points, return
            if (timestamps.length === 0) {
                return;
            }
            
            // Update chart with new data
            patternImpactChart.data.labels = timestamps;
            patternImpactChart.data.datasets[0].data = socValues;
            
            // Create pattern change annotations
            const annotations = [];
            patternEvents.forEach((pattern, index) => {
                if (pattern) {
                    annotations.push({
                        type: 'line',
                        xMin: index,
                        xMax: index,
                        borderColor: patternColors[pattern] || '#6c757d',
                        borderWidth: 2,
                        label: {
                            content: pattern,
                            enabled: true,
                            position: 'top'
                        }
                    });
                }
            });
            
            // Update chart
            patternImpactChart.update();
        }
        
        function showAlert(type, message, autoHide = true) {
            const alertId = 'alert-' + Date.now();
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            // Insert at the top of the alerts container
            $('#alerts-container').prepend(alertHtml);
            
            // Automatically remove alert after 5 seconds if autoHide is true
            if (autoHide) {
                setTimeout(() => {
                    $(`#${alertId}`).alert('close');
                }, 5000);
            }
        }
    </script>
</body>
</html>
